<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <title>Weekly Matches Control Panel</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 16px; }
    h1 { margin: 0 0 12px; font-size: 18px; }
    .card { border: 1px solid #e2e2e2; border-radius: 10px; padding: 12px; margin-bottom: 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .stack { display: flex; flex-direction: column; gap: 8px; }
    label { font-size: 12px; color: #333; display: block; margin-bottom: 4px; }
    input[type="text"], input[type="password"] { width: 300px; padding: 6px 8px; border-radius: 8px; border: 1px solid #cfcfcf; }
    button { padding: 8px 12px; border: 1px solid #cfcfcf; background: #fafafa; border-radius: 8px; cursor: pointer; }
    button:hover { background: #f1f1f1; }
    .muted { color: #666; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .tiny { font-size: 11px; }
    .status { position: sticky; top: 0; z-index: 10; padding: 6px 10px; margin-bottom: 8px;
              font: 13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
              background: #fffbe6; border: 1px solid #ffe58f; border-radius: 6px; }
    .status.busy::before { content: ""; display: inline-block; width: 12px; height: 12px; margin-right: 8px;
                            border: 2px solid #999; border-top-color: transparent; border-radius: 50%;
                            animation: spin 0.9s linear infinite; vertical-align: -2px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Debug output dock */
    .debug-dock { position: fixed; top: 50px; right: 16px; width: 600px; max-height: calc(100vh - 90px);
                  z-index: 20; background: #0f172a; color: #e2e8f0; border: 1px solid #334155;
                  border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,.25); display: flex;
                  flex-direction: column; overflow: hidden; }
    .debug-dock header { display: flex; align-items: center; justify-content: space-between;
                         gap: 8px; padding: 8px 10px; background: #111827; border-bottom: 1px solid #334155;
                         font: 13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .debug-dock header .title { font-weight: 600; }
    .debug-dock header .actions { display: flex; gap: 6px; }
    .debug-dock button { padding: 4px 8px; border: 1px solid #475569; background: #1f2937;
                         color: #e5e7eb; border-radius: 6px; font-size: 12px; cursor: pointer; }
    .debug-dock button:hover { background: #374151; }
    .debug-body { padding: 8px 10px; overflow: auto; resize: both; }
    .debug-body pre { margin: 0; white-space: pre-wrap; word-break: break-word;
                      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    .debug-dock.collapsed .debug-body { display: none; }
  </style>
</head>
<body>
  <h1>Weekly Matches Control Panel</h1>
  <div id="status" class="status" style="display:none">Working…</div>

  <!-- Debug Output Dock -->
  <div class="debug-dock" id="debugDock" aria-live="polite">
    <header>
      <span class="title">Debug Output</span>
      <div class="actions">
        <button id="dbgToggle" title="Collapse/Expand">Toggle</button>
        <button id="dbgCopy" title="Copy">Copy</button>
        <button id="dbgClear" title="Clear">Clear</button>
      </div>
    </header>
    <div class="debug-body">
      <pre id="debugOut"></pre>
    </div>
  </div>

  <!-- WebApp Secret -->
  <div class="card">
    <div class="row">
      <div>
        <label for="secret">WebApp Secret</label>
        <input id="secret" type="password" placeholder="enter WM_WEBAPP_SHARED_SECRET">
        <div class="tiny">
          <label><input id="remember" type="checkbox"> remember secret in this browser</label>
        </div>
      </div>
      <button id="btnState">Get State</button>
    </div>
  </div>

  <!-- Start Message ID Controls -->
  <div class="card">
    <div class="row">
      <div>
        <label for="startId">Start Message ID (inclusive)</label>
        <input id="startId" type="text" placeholder="e.g. 123456789012345678">
      </div>
      <button id="btnSet">Set Start ID</button>
      <button id="btnClear">Clear Start ID</button>
      <button id="btnStart">Start Polling (from ID)</button>
      <button id="btnStartPointer">Start Polling (from Pointer)</button>
    </div>
    <div class="tiny muted">Polling (from ID) will process that message first, then newer ones.</div>
  </div>

  <!-- Actions -->
  <div class="card">
    <div class="row">
      <button id="btnPost">Post/Update Weekly Board</button>
      <button id="btnResetIds" class="btn">Reset header/table IDs (this week)</button>
      <button id="btnDeleteCluster" class="btn btn-danger">Delete weekly cluster (this week)</button>
    </div>
    <div id="out" class="tiny mono muted" style="margin-top:8px;">ready.</div>
  </div>

  <script>
(function(){
  const $ = (id) => document.getElementById(id);


(function rememberSecretWiring(){
  const $ = (id) => document.getElementById(id);
  const secretEl = $('secret');
  const cb       = $('remember');

  function log(msg){ try { if (window.DBG) DBG.write(msg); } catch(_){} }

  function loadFromLocal() {
    if (!secretEl || !cb) return;
    try {
      const saved = localStorage.getItem('WM_SECRET') || '';
      if (saved) {
        secretEl.value = saved;
        cb.checked = true;
        log('remember-secret: loaded from localStorage');
      } else {
        cb.checked = false;
      }
    } catch (e) {
      log('remember-secret: localStorage read failed: ' + e);
    }
  }

  function persistToLocal() {
    if (!secretEl || !cb) return;
    try {
      if (cb.checked) {
        localStorage.setItem('WM_SECRET', secretEl.value || '');
        log('remember-secret: saved to localStorage');
      } else {
        localStorage.removeItem('WM_SECRET');
        log('remember-secret: removed from localStorage');
      }
    } catch (e) {
      log('remember-secret: localStorage write failed: ' + e);
    }
  }

  // Save on keystroke if "remember" is checked
  if (secretEl) secretEl.addEventListener('input', () => {
    if (cb && cb.checked) persistToLocal();
  });

  // Save / purge when checkbox toggles
  if (cb) cb.addEventListener('change', persistToLocal);

  // Load on startup
  loadFromLocal();

  // Expose a hook so runServer() can force-save right before calls
  window.__maybePersistSecret = persistToLocal;
  })();

  // ---- Status line + busy banner (no 'out' name to avoid clashing with #out element) ----
  function writeStatus(msg, cls){
    const el = $('out');
    if (!el) return;
    el.className = 'tiny mono ' + (cls || 'muted');
    el.textContent = String(msg);
  }
  function setBusy(isBusy, message){
    const status = $('status');
    if (!status) return;
    document.querySelectorAll('button').forEach(b => b.disabled = !!isBusy);
    if (isBusy) {
      status.textContent = message || 'Working…';
      status.classList.add('busy');
      status.style.display = 'block';
    } else {
      status.textContent = '';
      status.classList.remove('busy');
      status.style.display = 'none';
    }
  }

  // ---- Debug dock writer ----
  const DBG = (function(){
    const box = $('debugOut');
    const scroller = box && box.parentElement;
    function ts(){ return new Date().toLocaleString(); }
    function append(line){
      if (!box) return;
      box.textContent += line + '\n';
      if (scroller) scroller.scrollTop = scroller.scrollHeight;
    }
    return {
      write(msg){ append(`[${ts()}] ${msg}`); },
      json(label, data){
        const pretty = (typeof data === 'string') ? data : JSON.stringify(data, null, 2);
        append(`[${ts()}] ${label}\n${pretty}`);
      },
      clear(){ if (box) box.textContent = ''; }
    };
  })();

  // ---- Debug dock header buttons ----
  (function wireDock(){
    const dock = $('debugDock');
    $('dbgToggle')?.addEventListener('click', () => dock.classList.toggle('collapsed'));
    $('dbgCopy')?.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(($('debugOut')?.textContent) || ''); } catch(_){}
    });
    $('dbgClear')?.addEventListener('click', () => DBG.clear());
  })();

  // ---- Shared runner for server calls (uses debug dock + status line) ----
  function getSecret(){ return ($('secret')?.value || '').trim(); }
  function runServer(opName, fnName, args, busyMsg){
    // ensure secret is persisted if "remember" is checked
    try { if (window.__maybePersistSecret) window.__maybePersistSecret(); } catch(_){}
    const secret = (document.getElementById('secret')?.value || '').trim();
    DBG.write(`▶ ${opName}…`);
    writeStatus(`${opName}…`);
    setBusy(true, busyMsg || `${opName}…`);
    const chain = google.script.run
      .withSuccessHandler((res) => {
        DBG.json(`✅ ${opName} result`, res);
        writeStatus(res && res.ok ? `${opName}: ok` : `${opName}: error`, res && res.ok ? 'ok' : 'err');
        setBusy(false);
      })
      .withFailureHandler((err) => {
        DBG.json(`❌ ${opName} error`, { message: (err && err.message) || String(err) });
        writeStatus(`${opName}: script error`, 'err');
        setBusy(false);
      });
    return chain[fnName](secret, ...(args || []));
  }

  // ---- Button handlers (ALL routed to debug dock) ----

  // Get State (doesn’t require secret)
  $('btnState')?.addEventListener('click', () => {
    DBG.write('requesting state…');
    writeStatus('loading state…');
    google.script.run
      .withSuccessHandler((res) => {
        DBG.json('state', res);
        writeStatus(res.ok ? 'ok' : (res.error || 'error'), res.ok ? 'ok' : 'err');
        if (res.ok && $('state')) $('state').textContent = JSON.stringify(res.data, null, 2);
      })
      .withFailureHandler((e) => {
        DBG.json('state error', { message: (e && e.message) || String(e) });
        writeStatus('script error: ' + ((e && e.message) || e), 'err');
      })
      .server_getState();
  });

  // Set Start ID
  $('btnSet')?.addEventListener('click', () => {
    const id = ($('startId')?.value || '').trim();
    if (!/^\d{5,30}$/.test(id)) { writeStatus('invalid message id', 'err'); DBG.write('invalid message id'); return; }
    runServer('Set Start ID', 'server_setStartId', [id], 'Setting start id…');
  });

  // Clear Start ID
  $('btnClear')?.addEventListener('click', () => {
    runServer('Clear Start ID', 'server_clearStartId', [], 'Clearing start id…');
  });

  // Start Polling (from specific ID)
  $('btnStart')?.addEventListener('click', () => {
    const id = ($('startId')?.value || '').trim();
    if (!/^\d{5,30}$/.test(id)) { writeStatus('invalid message id', 'err'); DBG.write('invalid message id'); return; }
    runServer('Poll from ID', 'server_startPollingFrom', [id], 'Starting poll from ID…');
  });

  // Start Polling (from pointer)
  $('btnStartPointer')?.addEventListener('click', () => {
    runServer('Poll from pointer', 'server_startPolling', [], 'Starting poll from last pointer…');
  });

  // Post/Update Weekly Board
  $('btnPost')?.addEventListener('click', () => {
    runServer('Post/Update Weekly Board', 'server_postOrUpdate', [], 'Posting weekly board…');
  });
  $('btnResetIds').onclick = () => {
    const secret = $('secret').value.trim();
    if (!secret) { DBG.write('missing secret', 'err'); return; }
    setBusy(true, 'Resetting stored IDs…');
    google.script.run
      .withSuccessHandler(res => {
        if (res && res.ok !== false) {
          const data = res.data || res; // supports _ok_ or plain payload
          DBG.write('reset ok: ' + JSON.stringify(data), 'ok');
        } else {
          DBG.write(res && res.error ? res.error : 'reset failed', 'err');
        }
        setBusy(false);
      })
      .withFailureHandler(e => { DBG.write('script error: ' + e.message, 'err'); setBusy(false); })
      .server_resetWeeklyMsgIds(secret);
  };

  $('btnDeleteCluster').onclick = () => {
    const secret = $('secret').value.trim();
    if (!secret) { DBG.write('missing secret', 'err'); return; }
    setBusy(true, 'Deleting weekly cluster…');
    google.script.run
      .withSuccessHandler(res => {
        if (res && res.ok !== false) {
          const data = res.data || res; // supports _ok_ or plain payload
          DBG.write('deleted cluster: ' + JSON.stringify(data), 'ok');
        } else {
          DBG.write(res && res.error ? res.error : 'delete failed', 'err');
        }
        setBusy(false);
      })
      .withFailureHandler(e => { DBG.write('script error: ' + e.message, 'err'); setBusy(false); })
      .server_deleteWeeklyCluster(secret);
  };

})();
</script>
</body>
</html>