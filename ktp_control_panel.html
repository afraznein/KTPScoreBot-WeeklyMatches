<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>KTP Weekly Matches Panel</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #1f2937;
      --muted: #9CA3AF;
      --ok: #22c55e;
      --err: #ef4444;
      --warn: #f59e0b;
      --txt: #e5e7eb;
      --accent: #60a5fa;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    a {
      color: var(--accent);
      text-decoration: none;
    }

    h1 {
      margin: 16px 0 12px;
      font-size: 22px;
    }

    h2 {
      margin: 14px 0 8px;
      font-size: 16px;
      color: var(--muted);
      font-weight: 600;
    }

    .wrap {
      max-width: 1080px;
      margin: 0 auto;
      padding: 16px 20px 120px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }

    .card {
      background: var(--card);
      border: 1px solid #374151;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 1px 0 rgb(255 255 255 / 0.02) inset, 0 8px 24px rgb(0 0 0 / 0.25);
    }

    .card h2 {
      margin-top: 2px;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin: 6px 0;
    }

    .row label {
      font-size: 12px;
      color: var(--muted);
      margin-right: 6px;
    }

    .row input[type="text"],
    .row input[type="password"] {
      background: #0b1220;
      color: var(--txt);
      border: 1px solid #334155;
      padding: 8px 10px;
      border-radius: 8px;
      min-width: 220px;
      outline: none;
    }

    .row input[type="checkbox"] {
      transform: translateY(1px);
    }

    .btn {
      background: #0b1220;
      color: var(--txt);
      border: 1px solid #3b82f6;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn:hover {
      background: #0b1529;
    }

    .btn.warn {
      border-color: var(--warn);
      color: #fff;
    }

    .btn.danger {
      border-color: var(--err);
      color: #fff;
    }

    .btn.ok {
      border-color: var(--ok);
    }

    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .3px;
      border: 1px solid #374151;
      background: #0b1220;
      color: var(--muted);
    }

    .status {
      margin-left: 8px;
    }

    .status.ok {
      color: var(--ok);
      border-color: var(--ok);
    }

    .status.err {
      color: var(--err);
      border-color: var(--err);
    }

    .status.busy {
      color: var(--warn);
      border-color: var(--warn);
    }

    /* Debug dock (fixed, top-right) */
    .debug-dock {
      position: fixed;
      right: 16px;
      top: 16px;
      width: 420px;
      height: 52vh;
      background: var(--panel);
      border: 1px solid #374151;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 9999;
      box-shadow: 0 8px 28px rgba(0, 0, 0, .35);
    }

    .debug-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid #30363d;
      background: #0b1220;
    }

    .debug-head b {
      font-size: 12px;
      color: var(--muted);
    }

    .debug-actions {
      display: flex;
      gap: 6px;
    }

    .debug-actions .btn {
      padding: 6px 8px;
      font-size: 12px;
    }

    #debugOut {
      flex: 1;
      margin: 0;
      padding: 10px;
      font: 12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background: #0a0f1a;
      color: #d1d5db;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .collapsed #debugOut {
      display: none;
    }

    .footer-note {
      color: var(--muted);
      font-size: 11px;
      margin-top: 8px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>KTP Weekly Matches Panel</h1>

    <div class="grid">
      <!-- Connection / Secrets -->
      <div class="card" style="grid-column: span 12;">
        <h2>Connection</h2>
        <div class="row">
          <label for="secret">WebApp Secret</label>
          <input id="secret" type="password" placeholder="••••••••" />
          <label><input id="rememberSecret" type="checkbox" /> remember in this browser</label>
          <span id="connStatus" class="pill">idle</span>
        </div>
        <div class="row">
          <button id="btnVerifySecrets" class="btn">Verify Secrets</button>
          <button id="btnState" class="btn">Get State</button>
          <button id="btnProbe" class="btn">Probe Relay</button>
        </div>
        <div class="footer-note">
          Tip: Script properties supported: <code>WEBAPP_SECRET</code>, <code>WEBAPP_SECRET_V2</code>,
          <code>RELAY_SHARED_SECRET</code>, <code>PANEL_SECRET</code>. You can also set <code>DEV_MODE=true</code> and
          <code>SECRET_DEV</code>.
        </div>
      </div>

      <!-- Polling -->
      <div class="card" style="grid-column: span 12;">
        <h2>Polling</h2>
        <div class="row">
          <label for="startId">Start Message ID</label>
          <input id="startId" type="text" placeholder="e.g. 1423841447026622534" />
        </div>
        <div class="row">
          <button id="btnSet" class="btn">Set Start ID</button>
          <button id="btnClear" class="btn warn">Clear Start ID</button>
          <button id="btnStart" class="btn ok">Start Polling (from ID, inclusive)</button>
          <button id="btnStartPointer" class="btn">Start (from last pointer)</button>
        </div>
      </div>

      <!-- Historical Parsing -->
      <div class="card" style="grid-column: span 12;">
        <h2>Historical Parsing</h2>
        <div class="footer-note" style="margin-top: 0; margin-bottom: 10px;">
          Bulk re-parse old Discord messages from captains. Uses message timestamps to match schedules to historical weeks. Useful for back-filling schedules from earlier in the season.
        </div>
        <div class="row">
          <label for="histStartId">Start Message ID</label>
          <input id="histStartId" type="text" placeholder="e.g. 1423841447026622534" />
          <label><input id="skipScheduled" type="checkbox" checked /> Skip already-scheduled matches</label>
        </div>
        <div class="row">
          <button id="btnHistParse" class="btn ok">Parse Historical Messages</button>
        </div>
      </div>

      <!-- Weekly Board -->
      <div class="card" style="grid-column: span 12;">
        <h2>Weekly Board</h2>
        <div class="row">
          <button id="btnPost" class="btn ok">Post / Update Weekly Board</button>
          <button id="btnDelete" class="btn danger">Delete Weekly Cluster</button>
          <button id="btnResetIds" class="btn warn">Reset Saved Header/Table IDs</button>
        </div>
        <div class="row">
        </div>
      </div>
    </div>
  </div>

  <!-- Debug Dock -->
  <div id="debugDock" class="debug-dock">
    <div class="debug-head">
      <b>debug output</b>
      <div class="debug-actions">
        <button id="dbgToggle" class="btn">Hide</button>
        <button id="dbgCopy" class="btn">Copy</button>
        <button id="dbgClear" class="btn">Clear</button>
      </div>
    </div>
    <pre id="debugOut"></pre>
  </div>

  <script>
    // ---------- tiny DOM helpers ----------
    const $ = (id) => document.getElementById(id);

    // ---------- debug / status helpers ----------
    function nowTs() {
      try {
        return new Date().toLocaleString(undefined, { hour12: true });
      } catch (_){ return new Date().toISOString(); }
    }
    function out(msg, level) {
      const pre = $('debugOut');
      const line = `[${nowTs()}] ${String(msg)}`;
      pre.textContent += (pre.textContent ? '\n' : '') + line;
      pre.scrollTop = pre.scrollHeight;
    }
    function setBusy(isBusy, text) {
      const pill = $('connStatus');
      if (isBusy) {
        pill.textContent = text ? `busy — ${text}` : 'busy';
        pill.classList.remove('ok','err'); pill.classList.add('busy');
      } else {
        pill.textContent = 'idle';
        pill.classList.remove('busy','err'); pill.classList.add('ok');
      }
    }
    function setErr(text) {
      const pill = $('connStatus');
      pill.textContent = text || 'error';
      pill.classList.remove('busy','ok'); pill.classList.add('err');
    }

    // ---------- secret persistence ----------
    function sanitizeSecretFieldValue(val) {
      return String(val || '')
        .replace(/[\u200B-\u200D\uFEFF]/g, '')
        .replace(/\s+/g, ' ')
        .replace(/[“”]/g, '"').replace(/[‘’]/g, "'")
        .trim();
    }
    (function loadSecretFromLocalStorage(){
      try {
        const saved = localStorage.getItem('ktp_secret_v2');
        if (saved) {
          $('secret').value = saved;
          $('rememberSecret').checked = true;
        }
      } catch(_) {}
    })();
    $('rememberSecret').addEventListener('change', function() {
      try {
        if (this.checked) {
          localStorage.setItem('ktp_secret_v2', sanitizeSecretFieldValue($('secret').value));
        } else {
          localStorage.removeItem('ktp_secret_v2');
        }
      } catch(_) {}
    });
    $('secret').addEventListener('input', function() {
      if ($('rememberSecret').checked) {
        try { localStorage.setItem('ktp_secret_v2', sanitizeSecretFieldValue(this.value)); } catch(_) {}
      }
    });

    // ---------- button wiring ----------
    // Verify Secrets
    $('btnVerifySecrets').onclick = () => {
      setBusy(true, 'Verifying secrets…'); out('▶ Verify Secrets…');
      google.script.run.withSuccessHandler(res => {
        if (res.ok) { out('✅ Verify Secrets result\n' + JSON.stringify(res.data, null, 2), 'ok'); setBusy(false); }
        else { out('❌ ' + res.error, 'err'); setErr('bad secret props?'); }
      }).withFailureHandler(e => { out('script error: ' + e.message, 'err'); setErr('script error'); })
      .server_verifySecrets();
    };

    // Get State
    $('btnState').onclick = () => {
      setBusy(true, 'Getting state…'); out('▶ Get State…');
      google.script.run.withSuccessHandler(res => {
        if (res.ok) out('✅ State\n' + JSON.stringify(res.data, null, 2), 'ok');
        else out('❌ ' + res.error, 'err');
        setBusy(false);
      }).withFailureHandler(e => { out('script error: ' + e.message, 'err'); setBusy(false); })
      .server_getState();
    };

    $('btnProbe').onclick = () => {
    const secret = sanitizeSecretFieldValue($('secret').value);
    if (!secret) { out('missing secret','err'); return; }
    setBusy(true, 'Probing relay…'); out('▶ Probe Relay…');
    google.script.run.withSuccessHandler(res => {
      out(res.ok ? ('✅ Probe\n' + JSON.stringify(res.data, null, 2)) : ('❌ ' + res.error), res.ok ? 'ok' : 'err');
      setBusy(false);
    }).withFailureHandler(e => { out('script error: ' + e.message, 'err'); setBusy(false); })
    .server_probeRelay(secret);
  };

    // Set Start ID
    $('btnSet').onclick = () => {
      const secret = sanitizeSecretFieldValue($('secret').value);
      const id = $('startId').value.trim();
      if (!secret) { out('missing secret','err'); return; }
      if (!/^\d{5,30}$/.test(id)) { out('invalid message id','err'); return; }
      setBusy(true, 'Setting start id…'); out('▶ Set Start ID…');
      google.script.run.withSuccessHandler(res => {
        out(res.ok ? ('✅ set: ' + JSON.stringify(res.data)) : ('❌ ' + res.error), res.ok ? 'ok':'err');
        setBusy(false);
      }).withFailureHandler(e => { out('script error: ' + e.message, 'err'); setBusy(false); })
      .server_setStartId(secret, id);
    };

    // Clear Start ID
    $('btnClear').onclick = () => {
      const secret = sanitizeSecretFieldValue($('secret').value);
      if (!secret) { out('missing secret','err'); return; }
      setBusy(true, 'Clearing start id…'); out('▶ Clear Start ID…');
      google.script.run.withSuccessHandler(res => {
        out(res.ok ? '✅ cleared' : ('❌ ' + res.error), res.ok ? 'ok' : 'err');
        setBusy(false);
      }).withFailureHandler(e => { out('script error: ' + e.message, 'err'); setBusy(false); })
      .server_clearStartId(secret);
    };

    // Start Polling (inclusive)
    $('btnStart').onclick = () => {
      const secret = sanitizeSecretFieldValue($('secret').value);
      const id = $('startId').value.trim();
      if (!secret) { out('missing secret','err'); return; }
      if (!/^\d{5,30}$/.test(id)) { out('invalid message id','err'); return; }
      setBusy(true, 'Polling from ID (inclusive)…'); out('▶ Start Polling from ID (inclusive)…');
      google.script.run.withSuccessHandler(res => {
        out(res.ok ? ('✅ ' + JSON.stringify(res.data)) : ('❌ ' + res.error), res.ok ? 'ok' : 'err');
        setBusy(false);
      }).withFailureHandler(e => { out('script error: ' + e.message, 'err'); setBusy(false); })
      .server_startPollingFrom(secret, id);
    };

    // Start Polling (from last pointer)
    $('btnStartPointer').onclick = () => {
      const secret = sanitizeSecretFieldValue($('secret').value);
      if (!secret) { out('missing secret','err'); return; }
      setBusy(true, 'Polling from last pointer…'); out('▶ Start Polling from last pointer…');
      google.script.run.withSuccessHandler(res => {
        out(res.ok ? ('✅ ' + JSON.stringify(res.data)) : ('❌ ' + res.error), res.ok ? 'ok' : 'err');
        setBusy(false);
      }).withFailureHandler(e => { out('script error: ' + e.message, 'err'); setBusy(false); })
      .server_startPolling(secret);
    };

    // Parse Historical Messages
    $('btnHistParse').onclick = () => {
      const secret = sanitizeSecretFieldValue($('secret').value);
      const id = $('histStartId').value.trim();
      const skip = $('skipScheduled').checked;
      if (!secret) { out('missing secret','err'); return; }
      if (!/^\d{5,30}$/.test(id)) { out('invalid message id','err'); return; }
      setBusy(true, 'Parsing historical messages…');
      out('▶ Parse Historical Messages (skipScheduled=' + skip + ')…');
      google.script.run.withSuccessHandler(res => {
        if (res.ok) {
          const d = res.data;
          out('✅ Historical Parse Complete:\n' +
            '  Processed: ' + (d.processed || 0) + ' messages\n' +
            '  Updated: ' + (d.updated || 0) + ' schedules\n' +
            '  Skipped: ' + (d.skipped || 0) + ' (already scheduled)\n' +
            '  Errors: ' + (d.errors || 0) + '\n' +
            '  Time: ' + (d.tookMs || 0) + 'ms', 'ok');
        } else {
          out('❌ ' + res.error, 'err');
        }
        setBusy(false);
      }).withFailureHandler(e => { out('script error: ' + e.message, 'err'); setBusy(false); })
      .server_startPollingFrom(secret, id, skip);
    };

    // Post / Update Weekly Board
    $('btnPost').onclick = () => {
      const secret = sanitizeSecretFieldValue($('secret').value);
      if (!secret) { out('missing secret','err'); return; }
      setBusy(true, 'Posting/updating weekly board…'); out('▶ Post/Update Weekly Board…');
      google.script.run.withSuccessHandler(res => {
        out(res.ok ? ('✅ done: ' + JSON.stringify(res.data)) : ('❌ ' + res.error), res.ok ? 'ok' : 'err');
        setBusy(false);
      }).withFailureHandler(e => { out('script error: ' + e.message, 'err'); setBusy(false); })
      .server_postOrUpdate(secret);
    };

    // Delete Weekly Cluster
    $('btnDelete').onclick = () => {
      const secret = sanitizeSecretFieldValue($('secret').value);
      if (!secret) { out('missing secret','err'); return; }
      setBusy(true, 'Deleting weekly cluster…'); out('▶ Delete Weekly Cluster…');
      google.script.run.withSuccessHandler(res => {
        out(res.ok ? '✅ deleted' : ('❌ ' + res.error), res.ok ? 'ok' : 'err');
        setBusy(false);
      }).withFailureHandler(e => { out('script error: ' + e.message, 'err'); setBusy(false); })
      .server_deleteWeeklyCluster(secret);
    };

    // Reset saved message IDs (header/weekly/rematches)
    $('btnResetIds').onclick = () => {
      const secret = sanitizeSecretFieldValue($('secret').value);
      if (!secret) { out('missing secret','err'); return; }
      setBusy(true, 'Resetting saved IDs…'); out('▶ Reset Saved IDs…');
      // Try preferred name; fall back if you named it differently server-side
      google.script.run.withSuccessHandler(res => {
        if (res && res.ok) out('✅ IDs reset', 'ok');
        else out('❌ ' + (res && res.error), 'err');
        setBusy(false);
      }).withFailureHandler(e => { out('script error: ' + e.message, 'err'); setBusy(false); })
      .server_resetMsgIdsForCurrent(secret);
    };

    // Debug dock controls
    $('dbgToggle').onclick = () => {
      $('debugDock').classList.toggle('collapsed');
      $('dbgToggle').textContent = $('debugDock').classList.contains('collapsed') ? 'Show' : 'Hide';
    };
    $('dbgCopy').onclick = async () => {
      try {
        await navigator.clipboard.writeText($('debugOut').textContent);
      } catch (e) {}
    };
    $('dbgClear').onclick = () => { $('debugOut').textContent = ''; };


  </script>
</body>
</html>